<template>
	<div class="flex-grow">
		<div class="container mx-auto">
			<div class="mt-4">
				<svg class="fill-current text-ntt-blue w-48 sm:h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1709.19 415.17"><defs><clipPath id="clip-path" transform="translate(-102.93 -89.91)"><path class="cls-1" d="M102.93 301.51c0 96.92 220.17 178.6 520.31 203.57-203.74-31.08-419.8-99.4-419.8-175.83 0-116.61 322.44-211.17 716.36-211.17 271.46 0 535.34 64.38 639.43 130.29C1459.1 163.8 1151.05 89.91 819 89.91c-393.78 0-716.08 94.63-716.08 211.6"/></clipPath><linearGradient id="linear-gradient" x1="-2.89" y1="601.28" x2="2.14" y2="601.28" gradientTransform="matrix(0 84.56 84.56 0 -50114.41 239.01)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ffe4b8"/><stop offset=".5" stop-color="#ffcb05"/><stop offset="1" stop-color="#ad680e"/></linearGradient><clipPath id="clip-path-2" transform="translate(-102.93 -89.91)"><path class="cls-1" d="M203.44 329.25c0 76.43 216.06 144.77 419.81 175.83C474.85 467 320.81 411.69 320.81 340c0-106.56 285.38-193.12 633.59-193.12 239.91 0 489.61 42.24 604.83 101.49-104.09-65.92-368-130.29-639.43-130.29-393.92 0-716.36 94.56-716.36 211.17"/></clipPath><linearGradient id="linear-gradient-2" x1=".91" y1="587.5" x2="5.93" y2="587.5" gradientTransform="matrix(0 -76.14 -76.14 0 45510.53 483.53)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ffe4b8"/><stop offset=".25" stop-color="#ffcb05"/><stop offset="1" stop-color="#ad680e"/></linearGradient></defs><g clip-path="url(#clip-path)"><path fill="url(#linear-gradient)" d="M0 0h1456.29v415.17H0z"/></g><g clip-path="url(#clip-path-2)"><path fill="url(#linear-gradient-2)" d="M100.5 28.17h1355.79v387H100.5z"/></g><path class="cls-6" d="M299.6 178.41h67.2l4.41 82.5h.3l17.33-82.5h38.54l-24.49 117.07h-66.1l-5.03-84.79h-.37l-17.75 84.79H275.1l24.5-117.07zM555.63 212.98h-38.7l-17.23 82.5h-44.96l17.3-82.5h-38.7l7.24-34.57h122.28l-7.23 34.57zM689.76 212.98h-38.64l-17.3 82.5h-44.94l17.29-82.5h-38.61l7.19-34.57h122.27l-7.26 34.57z"/><path class="cls-6" d="M956.63 342.73c0 25.6-17 44.35-41.65 44.35-19.85 0-31.76-12.9-31.76-33.22 0-24.34 17.92-42.9 41.37-42.9 18.93 0 32 11.64 32 31.76m-19 .13c0-9.42-3.19-17.37-13.89-17.37-14.33 0-21.56 16.49-21.56 29.77 0 9.54 3.78 17.09 14.28 17.09 14.11 0 21.17-16.92 21.17-29.5M970.64 320.76c.55-2.92 1.15-5.84 1.53-8.18h16.94l-1.66 9.64h.3a25.51 25.51 0 0 1 21.42-11.22c8.39 0 16.9 5.11 17.8 13.65h.34c4.54-9.27 14.8-13.65 24.5-13.65 10.39 0 19.39 8.95 19.39 19.89 0 6.49-1.63 13.66-3.18 19.72l-7.31 34.72h-18.1l7.25-35.44c1-4.35 2.33-11.1 2.33-15.52a8.44 8.44 0 0 0-8.49-8.83c-12.62 0-15.71 15.29-18.05 25.23l-7.25 34.57h-18.11l7.3-35.44c.89-4.35 2.31-11.1 2.31-15.52a8.45 8.45 0 0 0-8.5-8.83c-12.43 0-15.77 15.45-18.09 25.23l-7.21 34.57H958zM1085.88 320.76c.5-2.92 1-5.84 1.46-8.18h17l-1.67 9.64h.35a25.28 25.28 0 0 1 21.36-11.22c8.23 0 16.8 5.11 17.72 13.65h.31c4.63-9.27 14.78-13.65 24.54-13.65 10.43 0 19.43 8.95 19.43 19.89 0 6.49-1.66 13.66-3.12 19.72l-7.4 34.72h-18.09l7.28-35.44c.93-4.35 2.28-11.1 2.28-15.52a8.41 8.41 0 0 0-8.52-8.83c-12.61 0-15.7 15.29-18 25.23l-7.22 34.57h-18.12l7.37-35.44c.87-4.35 2.26-11.1 2.26-15.52a8.4 8.4 0 0 0-8.54-8.83c-12.34 0-15.69 15.45-18 25.23l-7.22 34.57h-18.18zM1253.88 374.77c-.84 4.45-1.47 8.33-1.75 10.52h-17.81l1.26-7h-.27c-5.07 4.84-11.94 8.82-19.81 8.82-13.66 0-22.8-9-22.8-23.4 0-5.55 1.41-11.23 2.34-15.77l7.32-35.34h18.16l-6.77 34.32c-.9 5-2 9.82-2 15.25 0 6.09 4.1 10.21 9.88 10.21 12.64 0 17.2-12.42 19.54-23.24l7.41-36.55h18.24zM1278.57 322.93c.76-4.23 1.47-8 1.76-10.36h17.75l-1.19 7.16h.26c5-4.81 11.94-8.77 19.76-8.77 13.68 0 22.8 8.94 22.8 23.2 0 5.41-1.36 11.33-2.33 15.84l-7.34 35.29h-18.14l6.78-34.24c1-5 2.07-10 2.07-15.32 0-6.05-4.09-10.23-9.91-10.23-12.61 0-17.2 12.35-19.52 23.2l-7.44 36.6h-18.21zM1360 312.57h18.17l-14.88 72.71h-18.19zm6.7-31.26h18.15l-3.8 18h-18.18zM1437.65 329.19a23.66 23.66 0 0 0-13.27-3.7c-14.51 0-22.66 14.08-22.66 27.86 0 9.45 3 19 15.43 19a33.91 33.91 0 0 0 14.83-3.69l-2 14.93c-5.59 2.9-11.54 3.48-17.52 3.48-18 0-29.72-12.71-29.72-31.4 0-25.49 16.1-44.72 41.26-44.72a60.46 60.46 0 0 1 18.16 2.79zM1485.22 374.05h-.28c-6.29 8.29-12.45 13-22.48 13-12.63 0-21.55-7.46-21.55-20.82 0-24 25.76-26 42.79-26h6.41a23.37 23.37 0 0 0 .52-6.14c0-7.39-7.59-9.55-13.92-9.55a50.09 50.09 0 0 0-22.89 5.81l2.54-15.07a66.58 66.58 0 0 1 23.71-4.38c14 0 27.14 5.4 27.14 22.35 0 9.69-6.89 38.38-8.54 52h-15.31zm-17.77-.8c13.55 0 17.77-9.79 20.61-21.52h-6.33c-8.83 0-23.49 1.55-23.49 13.83 0 5.12 4.66 7.69 9.22 7.69M1518.07 312.57h13.12l3.11-14.87 19.57-6.8-4.49 21.67h16.26l-2.8 13.8h-16.3l-6.65 31.75a31 31 0 0 0-.78 7.1c0 4.37 2.85 7.12 6.91 7.12a22.54 22.54 0 0 0 8.75-1.67l-3.07 14.61c-3.14.75-6.64 1.79-9.74 1.79-12.43 0-21.07-5.11-21.07-19.08a80.76 80.76 0 0 1 2.29-17l5.17-24.67h-13.16zM1580.27 312.57h18.16l-14.9 72.71h-18.17zm6.64-31.26h18.18l-3.78 18h-18.22zM1674.94 342.73c0 25.6-17 44.35-41.59 44.35-19.85 0-31.76-12.9-31.76-33.22 0-24.34 17.93-42.9 41.36-42.9 18.83 0 32 11.64 32 31.76m-19.07.13c0-9.42-3-17.37-13.73-17.37-14.38 0-21.58 16.49-21.58 29.77 0 9.54 3.78 17.09 14.25 17.09 14.12 0 21.07-16.92 21.07-29.5M1690.44 322.93c.81-4.23 1.51-8 1.77-10.36H1710l-1.25 7.16h.32c5-4.81 11.93-8.77 19.82-8.77 13.66 0 22.76 8.94 22.76 23.2 0 5.41-1.33 11.33-2.26 15.84l-7.42 35.29h-18.17l6.85-34.24c1-5 2-10 2-15.32 0-6.05-4.08-10.23-9.91-10.23-12.66 0-17.23 12.35-19.57 23.2l-7.44 36.6h-18.19zM1808.13 328.05c-4.75-1.86-9.74-3.43-14.91-3.43-5.41 0-12.17 1.58-12.17 7.43 0 9.1 23.56 12.46 23.56 30.37 0 18.93-15.82 24.66-31.44 24.66a48.3 48.3 0 0 1-21.32-4.44l3.93-15.09c5.13 3 10.32 5.71 17.39 5.71 6.08 0 12.47-2.12 12.47-8.07 0-11.83-23.6-12.88-23.6-31.15 0-17 15.81-23.06 30.22-23.06a76.12 76.12 0 0 1 19.88 3zM883.41 306.35c-4.25-3-11.38-5.7-21.55-5.7-9.06 0-28.72 5.84-35.44 29.46-8.43 29.76 8.45 41.38 25.16 41.38a36.88 36.88 0 0 0 20.06-6.14l-3.35 18.94a77.12 77.12 0 0 1-21.46 2.78c-28.66 0-48.59-22.08-40.17-57 7.6-31.41 30.84-45 54.16-45 9.53 0 19.5 1.27 27.68 4.73z" transform="translate(-102.93 -89.91)"/></svg>
			</div>
		</div>
		<div class="px-4 flex flex-col">
			<div class="mt-2">
				<div class="container mx-auto">
					<div class="pt-2 flex items-center">
						<div class="">
							<button class="inline-block border border-grey-light hover:bg-ntt-blue text-ntt-blue hover:text-white pt-2 pb-1 px-2 rounded no-underline" @click.prevent="back"><font-awesome-icon :icon="faArrowLeft" /></button>
						</div>
						<div class="flex-grow hidden sm:block">
							<!-- Progress indicator -->
							<div class="flex items-center px-4">
								<template v-for="(question, qkey) in questions">
									<div class="w-3 h-3 border-2 border-ntt-blue rounded-full" :class="{'bg-ntt-blue': (question == currentQuestion || question.selected)}"></div>
									<div class="border-t-2 border-ntt-blue flex-grow" v-show="qkey !== ('q'+Object.keys(questions).length)"></div>
								</template>
							</div>
						</div>
						<div class="flex-grow block sm:hidden px-4">
							<span class="text-sm text-grey-darker">{{ $t('general.question') | toTitle}} {{currentQuestion.name}} {{$t('general.of')}} {{totalQuestions}}</span>
						</div>
					</div>
				</div>
			</div>
			<div class="container mx-auto py-2 text-grey-darker ">
				<span class="text-sm text-grey-dark hidden sm:block sm:my-2">{{ $t('general.question') | toTitle}} {{currentQuestion.name}} {{$t('general.of')}} {{totalQuestions}} -  {{currentQuestion.section | toTitle}}</span>
				<transition name="fade">
					<h1 class="font-light text-2xl sm:text-3xl leading-tight" v-show="showDetails" v-html="currentQuestion.question"></h1>
				</transition>
			</div>
			<div class="container mx-auto my-2 flex-grow">
				<transition name="fade">
					<div class="relative border p-2 text" :class="error.class" v-if="error">
						{{error.message}}
					</div>
				</transition>
				
				<template v-if="currentQuestion.type == 'button' || currentQuestion.type == 'checkbox'">
					<question-button :question="currentQuestion" :the-options="currentQuestion.options" v-on:selectOption="selectOption" :showDetails="showDetails" :qname="currentQuestion.qKey" :answer="answer"></question-button>
				</template>
				<template v-else-if="currentQuestion.type == 'slider'">
					<question-slider :question="currentQuestion" :the-options="currentQuestion.options" v-on:selectOption="selectOption" :showDetails="showDetails" :qname="currentQuestion.qKey" :answer="answer"></question-slider>
				</template>
				<template v-else-if="currentQuestion.type == 'groupSlider'">
					<group-slider :answer="answer" :question="currentQuestion" :selectOption="selectOption" :showDetails="showDetails"></group-slider>
				</template>
				<template v-else-if="currentQuestion.type == 'groupopposingslider'">
					<group-opposing-slider :answer="answer" :question="currentQuestion" :selectOption="selectOption" :showDetails="showDetails"></group-opposing-slider>
				</template>
				<template v-else-if="currentQuestion.type == 'groupbutton'">
					<group-button :answer="answer" :question="currentQuestion" :selectOption="selectOption" :showDetails="showDetails"></group-button>
				</template>
			</div>
			<div class="container mx-auto mt-4">
				<transition name="fade">
					<button :class="buttonClass" v-show="showNext" @click="nextQuestion($event)">
						<font-awesome-icon :icon="faSpinnerThird" size="2x" spin v-if="saving" /> <span v-else>{{$t('general.next')}}</span>
					</button>
				</transition>
			</div>
		</div>

	</div>
</template>

<script>
import FontAwesomeIcon from '@fortawesome/vue-fontawesome';
import faArrowLeft from '@fortawesome/fontawesome-pro-regular/faArrowLeft';
import faSpinnerThird from '@fortawesome/fontawesome-pro-regular/faSpinnerThird';

//Question components
import QuestionButton from '../components/QuestionButton.vue';
import QuestionSlider from '../components/QuestionSlider.vue';
import GroupSlider from '../components/GroupSlider.vue';
import GroupButton from '../components/GroupButton.vue';
import GroupOpposingSlider from '../components/GroupOpposingSlider.vue';

export default{
	data () {
		return {
			//section: this.$route.params.section,
			questions: laravel.questions,
			faArrowLeft: faArrowLeft,
			faSpinnerThird: faSpinnerThird,
			lang: {
				of: 'of',
				question: 'question',
				next: 'Next',
				multimaxierror: 'Please select a minimum of #number# and maximum of #max# to continue'
			},
			questionInfo: laravel.questionInfo,
			showNext: false,
			showDetails: true,
			answer: [],
			saving: false,
			normalButton: 'block w-full py-4 px-4 text-center bg-ntt-blue text-white',
			disabledButton: 'block w-full py-4 px-4 text-center bg-ntt-blue text-white opacity-50 cursor-not-allowed',
			error: false,
			errorClass: 'border-red-lighter bg-red-lightest text-red-light',
			noticeClass: 'border-blue-light bg-blue-lighter text-ntt-blue',
			result: []
		}
	},
	computed: {
		currentQuestion: function(){
			return this.questions['q'+ Number(this.$route.params.question)];
		},
		isGroup: function(){
			return this.currentQuestion.type === 'groupbutton' || this.currentQuestion.type === 'groupslider' || this.currentQuestion.type === 'groupopposingslider';
		},
		totalQuestions: function() {
			var total=0;
			for (var q in this.questions) {
				if (this.questions.hasOwnProperty(q)){
					total ++
				}
			}
			return total;
		},
		minimum: function(){
			return this.currentQuestion.min ? this.currentQuestion.min : 1;
		},
		maximum: function(){
			return this.currentQuestion.max ? this.currentQuestion.max : this.currentQuestion.options.length;
		},
		buttonClass: function(){
			return this.saving == true ? this.disabledButton : this.normalButton;
		}
	},
	methods: {
		nextQuestion: function(event){
			event.target.blur();
			if(this.saving)
				return;
			this.questions['q'+this.$route.params.question].selected = this.answer;
			var nextQ = Number(this.$route.params.question)+1;
			this.showNext = false;
			this.showDetails = false;
			var that = this;
			this.saving = true;
			this.saveAssessment().then(function (response) {
				if(response.data == 'success'){
					if(that.questions.hasOwnProperty('q'+nextQ)){
						setTimeout(function () {
							that.showDetails = true;
							that.$router.push({ path: '/questions/'+ nextQ});
							that.answer = [];
							that.saving = that.error = false;
							document.body.scrollTop = 0; // For Safari
	    					document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
						}, 300);
					}else{
						that.getResults().then(function (response) {
							if(response.data.query == 'success'){
								that.$router.push({ name: 'complete', params:{result: response.data.result}});
								document.body.scrollTop = 0; // For Safari
	    						document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
							}
						});
					}
				}
			});
		},
		selectOption: function(selected){
			//q16,16.1,"the label of the answer", true
			if(this.isGroup){
				// if(this.answer.length>0){
				if(this.currentQuestion.type == 'groupcheckbox'){
				
				}else if(this.currentQuestion.type == 'groupopposingslider'){
					var exists = false;
					for (var i = this.answer.length - 1; i >= 0; i--) {
						if(Array.isArray(this.answer[i])){
							for (var j = this.answer[i].length - 1; j >= 0; j--) {
								if(this.answer[i][j].name == selected[0].name){
									console.log(this.answer[i][j].name);
									exists = i;
								}
							}
						}
					}
					if(exists === false) {
						this.answer.push(selected);
					}else{
						this.answer.splice(exists, 1);
						if(this.answer.length==0) this.showNext = false;
						this.answer.push(selected);
					}
					if(this.answer.length == this.currentQuestion.options.length){
						this.showNext = true;
					}
				}else{
					var exists = false;
					for (var i = this.answer.length - 1; i >= 0; i--) {
						if(this.answer[i].name == selected.name){
							exists = i;
						}
					}
					if(exists === false) {
						this.answer.push(selected);
					}else{
						this.answer.splice(exists, 1);
						if(this.answer.length==0) this.showNext = false;
						this.answer.push(selected);
					}
					if(this.answer.length == this.currentQuestion.options.length){
						this.showNext = true;
					}
				}
			}else{
				var currentLength =this.answer.length;
				var exists = false;
				for (var i = this.answer.length - 1; i >= 0; i--) {
					if(this.answer[i].name == selected.name){
						exists = i;
					}
				}
				if(exists!==false){
					if(this.currentQuestion.type !== 'checkbox' || (this.currentQuestion.type === 'checkbox' && this.answer[exists].label == selected.label)){
						this.answer.splice(exists, 1);
						if(this.answer.length==0) this.showNext = false;
					}
					if(currentLength==0 || (currentLength+1 <= this.maximum && currentLength+1 >= this.minimum)) {
						this.answer.push(selected);
						this.showNext = true;
						this.error = false;
					}else{
						this.showError('minmax', this.lang.multimaxierror);
					}
				}else{
					this.answer = [];
					if(currentLength==0 || (currentLength+1 <= this.maximum && currentLength+1 >= this.minimum)) {
						this.answer.push(selected);
						this.showNext = true;
					}else{
						this.showError('minmax', this.lang.multimaxierror);
					}
				}
			}
		},
		back: function(){
			var previousQ = Number(this.$route.params.question)+1;
			this.showDetails = false;
			var that = this;
			setTimeout(function () {
				that.showDetails = true;
				that.$router.go(-1);
			}, 300);
		},
		showError: function(type, langString){
			var regX = /\#(.*?)\#/g;
			var repArr = {};
			if(type == 'minmax') {
				repArr.number = this.minimum;
				repArr.max = this.maximum;
			}
			var newStr = langString.replace(regX, function replacer(match, $1){
				return repArr[$1];
			});
			this.error = {message: newStr, class: this.errorClass}
		},
		saveAssessment: function(){
			var that = this;
			return axios.post('/api/tool/save-assessment', {
				question: this.currentQuestion.qKey,
				answer: this.answer,
			});

			/*return new Promise(function(resolve, reject) {
				setTimeout(resolve, 100, {data: 'success'});
			});*/
		},
		getResults: function(){
			var that = this;
			return axios.post('/api/tool/get-results');
		}
	},
	filters: {
		toTitle: function(value){
			return value.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
		}
	},
	components: {
		FontAwesomeIcon,
		QuestionButton,
		QuestionSlider,
		GroupSlider,
		GroupButton,
		GroupOpposingSlider,
	},
	created: function(){
		for (var q in this.questions) {
			if (this.questions.hasOwnProperty(q)){
				if(!this.questions[q].selected){
					console.log('not answered '+this.questions[q].name);
					this.$router.replace('/questions/'+ this.questions[q].name);
					this.showNext = false;
					break;
				}
			}
		}
	}
}
</script>